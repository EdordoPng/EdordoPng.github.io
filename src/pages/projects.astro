---
import BaseLayout from "../layouts/BaseLayout.astro";
import HorizontalCard from "../components/HorizontalCard.astro";
import { getCollection } from "astro:content";

// 1. Recuperiamo tutti i progetti ordinati per data decrescente
const posts = (await getCollection("projects")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 2. Calcoliamo i conteggi per ogni tag
const tagCounts = {};
posts.forEach(post => {
  (post.data.tags || []).forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});

// 3. Estraiamo i tag unici e li ordiniamo alfabeticamente (A-Z)
const sortedTags = Object.keys(tagCounts).sort((a, b) => a.localeCompare(b));
---

<BaseLayout title = "Projects" sideBarActiveItemID="projects">
  <div>
    <div class="text-3xl w-full font-bold mb-5">I Miei Progetti</div>
  </div>

  <div class="mb-8 flex flex-wrap gap-2" id="filter-container">
    <button 
      class="btn btn-outline btn-sm filter-btn btn-active" 
      data-filter="all">
      Tutti
    </button>
    
    {sortedTags.map((tag) => (
      <button 
        class="btn btn-outline btn-sm filter-btn" 
        data-filter={tag}>
        {tag} <span class="text-xs opacity-70 ml-1">({tagCounts[tag]})</span>
      </button>
    ))}
  </div>

  <div id="projects-grid">
    {posts.map((post) => (
      <div 
        class="project-item transition-all duration-300 ease-in-out" 
        data-tags={post.data.tags?.join(",") || ""}
      >
        <HorizontalCard
          title={post.data.title}
          img={post.data.heroImage}
          desc={post.data.description}
          url={"/projects/" + post.slug}
          target="_self"
          badge={post.data.badge}
          tags={post.data.tags}
          lang={post.data.lang}
        />
        <div class="divider my-0"></div>
      </div>
    ))}
  </div>

  <script is:inline>
    const filterButtons = document.querySelectorAll('.filter-btn');
    const projectItems = document.querySelectorAll('.project-item');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Gestione classe active
        filterButtons.forEach(btn => btn.classList.remove('btn-active'));
        button.classList.add('btn-active');

        const filterValue = button.getAttribute('data-filter');

        projectItems.forEach(item => {
          const itemTags = item.getAttribute('data-tags');
          
          if (filterValue === 'all' || itemTags.includes(filterValue)) {
            item.style.display = 'block';
            setTimeout(() => item.style.opacity = '1', 50);
          } else {
            item.style.opacity = '0';
            setTimeout(() => item.style.display = 'none', 300);
          }
        });
      });
    });
  </script>
</BaseLayout>