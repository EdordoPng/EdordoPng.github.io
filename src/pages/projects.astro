---
import BaseLayout from "../layouts/BaseLayout.astro";
import HorizontalCard from "../components/HorizontalCard.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

// 1. Recuperiamo tutti i progetti ordinati per data decrescente
const posts = (await getCollection("projects")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 2. Calcoliamo i conteggi per ogni tag
const tagCounts = {};
posts.forEach(post => {
  (post.data.tags || []).forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});

// 3. Estraiamo i tag unici e li ordiniamo per QuantitÃ  Decrescente
const sortedTags = Object.keys(tagCounts).sort((a, b) => {
  return tagCounts[b] - tagCounts[a];
});

// 4. Calcoliamo i badge unici
const badgeSet = new Set();
posts.forEach(post => {
  if (post.data.badge) {
    badgeSet.add(post.data.badge);
  }
});
const uniqueBadges = Array.from(badgeSet).sort();

---

<BaseLayout title="Projects" sideBarActiveItemID="projects">
  
  <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-5 gap-4">
    <div class="text-3xl font-bold">My Projects</div>
    
    <div class="mb-5 border-b border-base-300 pb-4">
    <div class="text-sm font-semibold mb-2 opacity-70">Filter by Macro-Category:</div>
    <div class="flex flex-wrap gap-2" id="badge-filter-container">
      <button class="btn btn-primary btn-sm badge-filter-btn btn-active" data-badge-filter="all">
        Tutte le Categorie
      </button>
      
      {uniqueBadges.map((badge) => (
        <button 
          class="btn btn-outline btn-sm badge-filter-btn" 
          data-badge-filter={badge}
        >
          {badge}
        </button>
      ))}
    </div>
  </div>

  <div class="mb-8">

    <div class="flex gap-2 w-full md:w-auto justify-end">
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-outline btn-sm m-1" title="Ordina Tag">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M7 12h10"/><path d="M10 18h4"/></svg>
          <span class="hidden md:inline ml-1">Ordina</span>
        </div>
        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 border border-base-200">
          <li><a id="sort-count">ðŸ“Š QuantitÃ  (Max-Min)</a></li>
          <li><a id="sort-alpha">ðŸ”¤ Alfabetico (A-Z)</a></li>
        </ul>
      </div>

      <button id="view-toggle-btn" class="btn btn-outline btn-sm m-1" title="Cambia Vista">
        <svg id="icon-list" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="block"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        <svg id="icon-grid" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
      </button>
    </div>
  </div>

  <div class="mb-8">
    <div class="flex flex-wrap gap-2" id="filter-container">
      <button class="btn btn-outline btn-sm filter-btn btn-active" data-filter="all">
        Tutti
      </button>
      
      {sortedTags.map((tag) => (
        <button 
          class="btn btn-outline btn-sm filter-btn tag-btn" 
          data-filter={tag}
          data-name={tag}
          data-count={tagCounts[tag]}
        >
          {tag} <span class="text-xs opacity-70 ml-1">({tagCounts[tag]})</span>
        </button>
      ))}
    </div>

    {sortedTags.length > 10 && (
      <button id="expand-tags-btn" class="btn btn-ghost btn-xs mt-2 w-full text-opacity-50 hover:text-opacity-100">
        Mostra altri {sortedTags.length - 10} tag â–¼
      </button>
    )}
  </div>

  <div id="projects-grid" class="flex flex-col gap-4 transition-all duration-300">
    {posts.map((post) => (
      <div 
        class="project-item transition-all duration-300 ease-in-out" 
        data-tags={post.data.tags?.join(",") || ""}
      >
        <div class="view-list block">
          <HorizontalCard
            title={post.data.title}
            img={post.data.heroImage}
            desc={post.data.description}
            url={"/projects/" + post.slug}
            target="_self"
            badge={post.data.badge}
            tags={post.data.tags}
            lang={post.data.lang}
          />
          <div class="divider my-0"></div>
        </div>

        <div class="view-grid hidden h-full">
          <a href={"/projects/" + post.slug} class="block h-full">
            <div class="group card bg-base-100 shadow-sm hover:shadow-xl transition-all duration-300 h-full border border-base-200 hover:bg-neutral">
              
              <figure class="relative overflow-hidden aspect-video">
                {post.data.heroImage && (
                  <Image
                    src={post.data.heroImage}
                    width={750}
                    height={422}
                    format="webp"
                    alt={post.data.title}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                )}
                {post.data.lang && (
                  <div class="absolute bottom-2 right-2 badge badge-neutral text-xs font-bold opacity-90 group-hover:bg-base-100 group-hover:text-neutral">
                    {post.data.lang}
                  </div>
                )}
              </figure>

              <div class="card-body p-4 text-center">
                <h2 class="card-title justify-center text-lg font-bold transition-colors text-base-content group-hover:text-neutral-content">
                  {post.data.title}
                </h2>
                
                {post.data.badge && (
                  <div class="badge badge-secondary mx-auto group-hover:bg-base-100 group-hover:text-neutral">
                    {post.data.badge}
                  </div>
                )}
              </div>
            </div>
          </a>
        </div>

      </div>
    ))}
  </div>

  <script is:inline>
    // ==========================================
    // 1. LOGICA FILTRI (Badge e Tag)
    // ==========================================
    const activeTags = new Set();
    const activeBadges = new Set();
    
    // Nodi DOM
    const tagButtons = document.querySelectorAll('.filter-btn');
    const badgeButtons = document.querySelectorAll('.badge-filter-btn');
    const projectItems = document.querySelectorAll('.project-item');

    // Funzione principale di filtraggio
    function applyFilters() {
      projectItems.forEach(item => {
        const itemTags = item.getAttribute('data-tags').split(',');
        const itemBadge = item.querySelector('.badge-secondary')?.textContent?.trim() || '';

        // Filtro 1: Macro-Categoria (Badge)
        const isBadgeMatch = activeBadges.size === 0 || activeBadges.has(itemBadge);

        // Filtro 2: Tag
        const isTagMatch = activeTags.size === 0 || itemTags.some(t => activeTags.has(t));

        const isVisible = isBadgeMatch && isTagMatch;
        
        // Applica visibilitÃ 
        if (isVisible) {
          item.style.display = 'block'; 
          setTimeout(() => item.style.opacity = '1', 50);
        } else {
          item.style.opacity = '0';
          setTimeout(() => item.style.display = 'none', 300);
        }
      });
      // Importante: disattiva/attiva i tag disponibili in base al badge selezionato
      updateTagButtonAvailability(); 
    }
    
    // Funzione per aggiornare la UI dei bottoni (Tags)
    function updateTagButtonAvailability() {
        const isMacroFilterActive = activeBadges.size > 0;
        
        tagButtons.forEach(btn => {
            const btnTag = btn.getAttribute('data-filter');
            if (btnTag === 'all') return;

            if (isMacroFilterActive) {
                // Se Ã¨ selezionata una Macro, disabilita i tag non presenti in quella Macro
                let foundInMacro = false;
                projectItems.forEach(item => {
                    const itemTags = item.getAttribute('data-tags').split(',');
                    const itemBadge = item.querySelector('.badge-secondary')?.textContent?.trim() || '';
                    
                    if (activeBadges.has(itemBadge) && itemTags.includes(btnTag)) {
                        foundInMacro = true;
                    }
                });
                
                btn.disabled = !foundInMacro;
                if (!foundInMacro) {
                    btn.classList.remove('btn-active');
                    activeTags.delete(btnTag); // Rimuove il tag se disabilitato
                }
            } else {
                // Nessun filtro Macro, tutti i tag sono disponibili
                btn.disabled = false;
            }
        });
        
        // Ritorna al filtro iniziale
        if (!isMacroFilterActive && activeTags.size > 0) {
            applyFilters();
        }
    }


    // Listener Badge Filter
    badgeButtons.forEach(button => {
      button.addEventListener('click', () => {
        const badge = button.getAttribute('data-badge-filter');
        activeBadges.clear();
        activeTags.clear(); // Resetta i tag quando cambi macro-categoria

        if (badge !== 'all') {
          activeBadges.add(badge);
        }

        // Update UI Badges
        badgeButtons.forEach(btn => {
          const btnBadge = btn.getAttribute('data-badge-filter');
          if (btnBadge === 'all') {
            activeBadges.size === 0 ? btn.classList.add('btn-active') : btn.classList.remove('btn-active');
          } else {
            activeBadges.has(btnBadge) ? btn.classList.add('btn-active') : btn.classList.remove('btn-active');
          }
        });
        
        // Reset UI Tags e applica filtri
        tagButtons.forEach(btn => {
            btn.classList.remove('btn-active');
        });
        document.querySelector('.filter-btn[data-filter="all"]').classList.add('btn-active');
        
        applyFilters();
      });
    });


    // Listener Tag Filter (Logica invariata per selezione multipla, ma ora chiama applyFilters)
    tagButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tag = button.getAttribute('data-filter');
        if (button.disabled) return; // Ignora se disabilitato dalla macro

        if (tag === 'all') {
          activeTags.clear();
        } else {
          if (activeTags.has(tag)) activeTags.delete(tag);
          else activeTags.add(tag);
        }

        // Update UI Bottoni
        tagButtons.forEach(btn => {
          const btnTag = btn.getAttribute('data-filter');
          if (btnTag === 'all') {
            activeTags.size === 0 ? btn.classList.add('btn-active') : btn.classList.remove('btn-active');
          } else {
            activeTags.has(btnTag) ? btn.classList.add('btn-active') : btn.classList.remove('btn-active');
          }
        });

        applyFilters();
      });
    });

    // ==========================================
    // 2. LOGICA CAMBIO VISTA (Lista/Griglia) - Invariata
    // ==========================================
    const toggleViewBtn = document.getElementById('view-toggle-btn');
    const container = document.getElementById('projects-grid');
    const iconList = document.getElementById('icon-list');
    const iconGrid = document.getElementById('icon-grid');
    let isGridView = false;

    toggleViewBtn.addEventListener('click', () => {
      isGridView = !isGridView;
      
      if (isGridView) {
        iconList.classList.add('hidden');
        iconGrid.classList.remove('hidden');
        container.classList.remove('flex', 'flex-col');
        container.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-6');
      } else {
        iconList.classList.remove('hidden');
        iconGrid.classList.add('hidden');
        container.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-6');
        container.classList.add('flex', 'flex-col');
      }

      const listCards = document.querySelectorAll('.view-list');
      const gridCards = document.querySelectorAll('.view-grid');

      listCards.forEach(c => isGridView ? c.classList.replace('block', 'hidden') : c.classList.replace('hidden', 'block'));
      gridCards.forEach(c => isGridView ? c.classList.replace('hidden', 'block') : c.classList.replace('block', 'hidden'));
    });

    // ==========================================
    // 3. LOGICA ESPANSIONE TAG (Show More/Less) - Invariata
    // ==========================================
    const expandBtn = document.getElementById('expand-tags-btn');
    const filterContainer = document.getElementById('filter-container');
    let isTagsExpanded = false;
    const TAG_LIMIT = 10;

    function applyTagLimit() {
      // Selezioniamo solo i bottoni che sono veri tag (escludendo "Tutti")
      const tagButtons = Array.from(filterContainer.querySelectorAll('.tag-btn'));
      
      tagButtons.forEach((btn, index) => {
        if (isTagsExpanded) {
          btn.classList.remove('hidden'); 
        } else {
          if (index < TAG_LIMIT) {
            btn.classList.remove('hidden');
          } else {
            btn.classList.add('hidden');
          }
        }
      });

      if (expandBtn) {
        // Aggiorna testo bottone
        expandBtn.innerHTML = isTagsExpanded 
          ? 'Mostra meno â–²' 
          : `Mostra altri ${tagButtons.length - TAG_LIMIT} tag â–¼`;
      }
    }

    if (expandBtn) {
      expandBtn.addEventListener('click', () => {
        isTagsExpanded = !isTagsExpanded;
        applyTagLimit();
      });
      // Applica limite all'avvio
      applyTagLimit();
    }

    // ==========================================
    // 4. LOGICA ORDINAMENTO TAG - Invariata
    // ==========================================
    const sortAlphaBtn = document.getElementById('sort-alpha');
    const sortCountBtn = document.getElementById('sort-count');

    function sortTags(criteria) {
      const allButtons = Array.from(filterContainer.querySelectorAll('.filter-btn'));
      const tuttiButton = allButtons[0];
      const tagButtons = allButtons.slice(1);

      tagButtons.sort((a, b) => {
        if (criteria === 'alpha') {
          return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
        } else {
          return parseInt(b.getAttribute('data-count')) - parseInt(a.getAttribute('data-count'));
        }
      });

      filterContainer.innerHTML = '';
      filterContainer.appendChild(tuttiButton);
      tagButtons.forEach(btn => filterContainer.appendChild(btn));

      if (expandBtn) applyTagLimit();
      // Mantenere lo stato del filtro badge dopo l'ordinamento
      updateTagButtonAvailability();
    }

    sortAlphaBtn.addEventListener('click', () => sortTags('alpha'));
    sortCountBtn.addEventListener('click', () => sortTags('count'));

  </script>
</BaseLayout>